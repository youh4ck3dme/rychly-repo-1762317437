name: Security & Lighthouse Audit

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Start preview server
        run: npm run preview &
      - name: Wait for server
        run: |
          n=0
          until [ $n -ge 20 ]; do
            curl -sSf http://localhost:4173 >/dev/null 2>&1 && break
            n=$((n+1))
            sleep 1
          done
          [ $n -ge 20 ] && echo "Server failed to start" && exit 1 || echo "Server is up"
      - name: Lighthouse (home)
        run: npx lighthouse http://localhost:4173 --output=json --output-path=./lighthouse-home.json --quiet || true
      - name: Upload Lighthouse artifact
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-home.json

  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: npm audit (moderate)
        run: npm audit --audit-level=moderate || echo "Advisories found"
      - name: Summary
        run: |
          echo "## Security & Lighthouse Manual Run" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse + dependency audit complete" >> $GITHUB_STEP_SUMMARY
